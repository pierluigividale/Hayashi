This is a copy of the code by Brian Medeiros (NCAR), with an important bug fix
